---
title: "Multiple Regression: Diagnostics - Week 10, Lecture 1"
author: "Hector Gavilanes"
format: html
self-contained: true
editor: source
---

**Recall the airline data from last week; we modeled revenue as a function of distance and population. The data are given here: [Google Sheet](https://docs.google.com/spreadsheets/d/10ZN0jMYdVsG2ucIJFSTquVRW916Jj-JmZIGQuqSQhy0/edit?usp=sharing).**

## Libraries
```{r setup, echo = TRUE, warnings = FALSE, message = FALSE}
library(tidyverse)
library(gsheet)
library(lindia) # Influence & Leverage: gg_cooksd()
library(car) #multicollinearity: vif()
library(olsrr) #multicollinearity: vif()
```

## Data
```{r}
# clear environment
rm(list = ls())

# extract data
data <- as_tibble(gsheet2tbl("https://docs.google.com/spreadsheets/d/10ZN0jMYdVsG2ucIJFSTquVRW916Jj-JmZIGQuqSQhy0/edit?usp=sharing"))
```

1. Summarize your findings from last week. What was the resulting model, which were significant predictors of revenue (no formal hypothesis test needed - just state with appropriate evidence)? Also include the graph constructed to visualize the model.
```{r}
airport_model <- lm(data$Revenue ~ data$Population + data$Distance)
```

## Model formula:
$$\hat{y} = 144.39 + 1.09{\text{ population}} + 0.17{\text{ distance}} $$
#### Significant Predictor: Population
After adjusted for revenue, there was sufficient evidence to suggest that population was a significant predictor with a $p < 0.001$.

#### Graph the Multiple Linear Model
```{r}
# get coefficients
c1 <- coefficients(airport_model)
c1
# Distance on the X-axis
quantile(data$Population, na.rm = TRUE)
# create lines graph for Distance of 55, 74, 150
data <- data %>%
  mutate(d55 = c1[1] + c1[2]*55 + c1[3]*Distance,
         d74 = c1[1] + c1[2]*74 + c1[3]*Distance,
         d150 = c1[1] + c1[2]*150 + c1[3]*Distance)
```

#### Visualizing Population
```{r}
# Population on the X-axis
quantile(data$Distance, na.rm = TRUE)
# create lines graph for Population of 150, 211, 300
data <- data %>%
  mutate(p150 = c1[1] + c1[2]*Population + c1[3]*150,
         p211 = c1[1] + c1[2]*Population + c1[3]*211,
         p300 = c1[1] + c1[2]*Population + c1[3]*300)
# ggplot graph
data %>% ggplot(aes(x = Population, y = Revenue)) +
  geom_point(size=3, color = "darkgray") + 
  geom_line(aes(y = p150), color = "orange") +
  geom_line(aes(y = p211), color = "magenta") +
  geom_line(aes(y = p300), color = "blue") +
  geom_text(aes(x =260, y = 460, label = "15,000 persons")) +
  geom_text(aes(x = 262, y = 445, label = "7,400 persons")) +
  geom_text(aes(x = 262, y = 430, label = "5,500 persons")) +
  labs(title = "Multiple Linear Regression",
       x = "Population",
       y = "Revenue") +
  xlim(c(50, 275))+
  theme_bw()
```

2. Determine if there are outliers in this model. Be sure to count and list the observations that are outliers.
```{r}
n = 2.5
data <- data %>% 
  mutate(Outlier = abs(rstandard(airport_model)) > n)
data %>% count(Outlier)

outlier_df <- data %>% 
  select(Revenue, Distance, Population, Outlier) %>% 
  drop_na() %>% 
  mutate(obs = row_number()) 
```

3. Determine if there are any influence and leverage points in this model. Be sure to count and list the observations that are considered influential and leverage.
```{r}
gg_cooksd(airport_model) + theme_bw()
```
- Points 20, 21, 22 need further investigation.

4. Is there evidence of multicollinearity? 
```{r}
vif(airport_model)
ols_vif_tol(airport_model)

collinearity_model <- lm(data$Revenue ~ data$Population * data$Distance)
ols_vif_tol(collinearity_model)
```

5. Perform a sensitivity analysis: remove the data points identified as potential offenders in Q2 and Q3 and reconstruct the model. Be sure to state the resulting model.
```{r}
sensitivity_df <- outlier_df %>% 
  filter(Outlier == FALSE & !obs %in% c(20, 21, 22))
# data$Revenue ~ data$Population + data$Distance
sensitivity_model <- lm(outlier_df$Revenue ~ outlier_df$Population + outlier_df$Distance)
summary(sensitivity_model)
```
## Sensitivity Model formula:
$$\hat{y} = 144.39 + 1.09{\text{ population}} + 0.17{\text{ distance}} $$

6. Using the model in Q5, are there any significant predictors of revenue?

7. Reconstruct the data visualization from last week, but using the new model's results.

8. Put the graphs from last week and Q7 side by side (hint: use `ggpubr`).

9. Compare and contrast the modeling results and the graphs that are side by side in Q8.

10. Why do you think I assigned this particular dataset for analysis? What are you taking away from this assignment?