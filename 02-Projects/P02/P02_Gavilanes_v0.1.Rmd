---
title: "Project 2"
author: "Hector Gavilanes"
format: html
self-contained: true
editor: source
---

```{r setup, echo = TRUE, warnings = FALSE, message = FALSE}
library(tidyverse)
library(gsheet)
library(formattable)
library(DescTools) # perform Dunnett, Levene Test
library(pgirmess) # perform Kruskal-Wallis Post-hoc
library(ggpubr) # interaction plot
```

**1. Consider a sample of data from the [Jackson Heart Study](https://www.jacksonheartstudy.org/). In this problem, we will be examining body mass index (*BMI*; kg/m<sup>2</sup>) as a function of health as categorized by physical activity (*PA3cat*; Ideal Health, Intermediate Health, and Poor Health).**

```{r}
# clear environment
rm(list = ls())
# import data
data <- as_tibble(gsheet2tbl("https://docs.google.com/spreadsheets/d/1H3TP-2SBMGleriJLESOe1cdCjtSj2F76bUh5iBqC8tI/edit#gid=2142000894"))
# clean data
clean_data <- data %>% 
  select(BMI, BMI3cat) %>% 
  drop_na()

# ---CUSTOM COLORS---
custom_green_dark = "#71CA97"
custom_green_light = "#DeF7E9"
custom_gray = "#3D3D3D"
custom_orange = "#FC7307"
custom_purple = "#5A18C9"
custom_tan_light = "#F7E3D4"
custom_density_hue = c(custom_purple,custom_orange)
# ---FUNCTIONS---
# f00 - Change default table format
change_table_format <- function(data_table){
  # local variables
  first_column <- data_table[1]
  dataframe_length <- NCOL(data_table)
  # format
  formattable(data_table, align = c("l",rep("c", dataframe_length - 1)),
              list(first_column = formatter("span", style = ~ style(color = custom_gray, font.weight = "bold")),
              area(row = 1, col = 2:dataframe_length) ~ color_tile(custom_green_light, custom_green_dark)
              )#/end list
              )#/end formattable
}
# f01 - get custom summary statistics
# !! sym() creates a symbol from a string
get_custom_summary <- function(data_table, category, values){
  summary <- data_table %>%
    group_by(!! sym(category)) %>% 
    summarise(Avg = mean(!! sym(values)),
              Median = median(!! sym(values)),
              SD = sd(!! sym(values)),
              Min = min(!! sym(values)),
              Max = max(!! sym(values)),
              IQRange = IQR(!! sym(values))
              )
    return(summary)
}
```


**a. Find the appropriate summary statistics to summarize the data.**
```{r}
change_table_format(get_custom_summary(clean_data, "BMI3cat", "BMI"))
```

**b. Use ANOVA to determine if there is a difference in BMI between the three levels of health as categorized by physical activity. Test at the $\alpha=0.05$ level.**
```{r}
# One-way ANOVA
# Null Hypothesis:
# - H0: All means of observations grouped by BMI are the same
# - H1: At least one category is different

h1 <- aov(clean_data$BMI ~ clean_data$BMI3cat)
summary(h1)

```

**c. Use the Kruskal-Wallis to determine if there is a difference in BMI between the three levels of health as categorized by physical activity (*PA3cat*; Ideal Health, Intermediate Health, and Poor Health). Test at the $\alpha=0.05$ level.**
```{r}
kruskal.test(clean_data$BMI ~ clean_data$BMI3cat)

```

**d. State/explain the ANOVA assumptions and assess them. Remember to state your conclusion (that you either meet the ANOVA assumptions or you do not).**
```{r}
# Do not assume ANOVA Assumptions
plot(h1)

# Levene's test for equality of variance
LeveneTest(clean_data$BMI ~ clean_data$BMI3cat,
           exact = FALSE)
```

**e. Based on your responses in part (d), which test's result are you going to present to the lead scientist at the JHS? (Hint: you will pick either (b) or (c)).**
Nonparametric test, Kruskal-Wallis in this case.
**f. Perform the appropriate posthoc test to determine pairwise differences between the three groups. Test at the $\alpha=0.05$ level.**
```{r}
# Kruskal-Wallis post-hoc
kruskalmc(clean_data$BMI ~ clean_data$BMI3cat)

# Multiple pairwise-comparison between groups
pairwise.wilcox.test(clean_data$BMI, clean_data$BMI3cat,
                     p.adjust.method = "bonferroni",
                     exact = FALSE)
```

**g. Write a brief paragraph describing the results of your analysis. Include summary statistics, results of your chosen hypothesis test from part (e), results of the posthoc test in part (f), and a graph to help convey the results.**

**2. Again, consider the sample of data from the JHS. In this problem, we will be examining systolic blood pressure (*sbp*; mmHg) as a function of health as categorized by body mass index (*BMI3cat*; Ideal Health, Intermediate Health, and Poor Health), smoking status (*everSmoker*; 0=never smoker, 1=former or current smoker), and the interaction between health as categorized by body mass index and smoking status.**

```{r}
blood_data <- data %>% 
  select(BMI3cat, BMI, everSmoker) %>% 
  drop_na()
```

**a. Find the appropriate summary statistics to summarize the data.**
```{r}
# change_table_format(get_custom_summary(blood_data, "everSmoker", "BMI"))
bmi_smoke_mean <- tapply(blood_data$BMI, INDEX = list(blood_data$BMI3cat, blood_data$everSmoker), FUN = mean)
formattable(bmi_smoke_mean)
# attributes(bmi_smoke_mean)
```

**b. Use ANOVA to determine if there is a difference in systolic blood pressure between health as categorized by body mass index, smoking status, and the interaction between health as categorized by body mass index and smoking status. Test at the $\alpha=0.05$ level. Remember to remove the interaction term if appropriate to do so.**
```{r}
# Two-way ANOVA with Interaction
# Null Hypothesis:
# - H1: The means of observations grouped by BMI are the same
# - H2: The means of observations grouped by Smoking are the same
# - H3: There is no interaction between BMI and Smoking

summary(h3_interaction <- aov(blood_data$BMI ~ blood_data$BMI3cat * factor(blood_data$everSmoker)))
```
Reject H1.
Reject H2.
Keep H3.

After removing the interaction term, the ANOVA table was reconstructed.
```{r}
# Two-way ANOVA
summary(two_way <- aov(blood_data$BMI ~ factor(blood_data$BMI3cat) + factor(blood_data$everSmoker)))
```

**c. Construct a profile plot to help explain results of part (b).**

```{r}
# profile plot using ggline
profile <- ggline(blood_data, x = "BMI3cat", y = "BMI", color = "everSmoker",
       add = "mean",
       show.line.label = FALSE,
       palette = c("magenta", "gray"),
       xlab = "BMI Health Categories",)+
  theme_bw()
  
interaction_plot <- ggpar(profile, 
                      main = "Interaction Plot: \n BMI Health & Smoking Status",
                      legend.title = "Smoking Status",
                      legend = "right",
                      ylim = c(20, 40))
interaction_plot

# smoke
# profile plot using ggline
profile <- ggline(blood_data, x = "everSmoker", y = "BMI", color = "BMI3cat",
       add = "mean",
       show.line.label = FALSE,
       palette = c("magenta", "gray", "orange"),
       xlab = "BMI Health Categories",)+
  theme_bw()
```

**d. Use the appropriate posthoc test to determine differences in main effects or the interaction term, whichever is appropriate for the results in part (b). Test at the $\alpha=0.05$ level.**

## Levene's Test for Equality of Variances
```{r}
LeveneTest(blood_data$BMI ~ blood_data$BMI3cat * blood_data$everSmoker)
```
## ANOVA Assumption
```{r}
plot(h3_interaction)
```


## Main Effects for BMI Health
```{r}
kruskal.test(blood_data$BMI ~ blood_data$BMI3cat)
kruskalmc(blood_data$BMI ~ blood_data$BMI3cat)
pairwise.wilcox.test(blood_data$BMI, blood_data$BMI3cat,
                     p.adjust.method = "bonferroni",
                     exact = FALSE)
DunnTest(blood_data$BMI ~ blood_data$BMI3cat)
```

## Main Effects for Smoking Health
```{r}
kruskal.test(blood_data$BMI ~ blood_data$everSmoker)
kruskalmc(blood_data$BMI ~ blood_data$everSmoker)
pairwise.wilcox.test(blood_data$BMI, blood_data$everSmoker,
                     p.adjust.method = "bonferroni",
                     exact = FALSE)
DunnTest(blood_data$BMI ~ blood_data$everSmoker)
```

**e. Write a brief paragraph describing the results of your analysis. Include summary statistics, results of the hypothesis testing in part (b), results of the posthoc test in part (d), and the profile plot in part (c) to help convey the results.**

